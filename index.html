<!DOCTYPE html>
<html>
<head>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script src="https://unpkg.com/textalive-app-api/dist/index.js"></script>
<script type="module">

  const { Player } = TextAliveApp;

  // 単語が発声されていたら #text に表示する

const animateWord = function (now, unit) {

  if (unit.contains(now)) {

    document.querySelector("#text").textContent = unit.text;

  }

};



// TextAlive Player を作る

const player = new Player({
  app: { token: "" },
  mediaElement: document.querySelector("#media"),
  mediaBannerPosition: "top right"
});

player.addListener({

  // 動画オブジェクトの準備が整ったとき（楽曲に関する情報を読み込み終わったとき）に呼ばれる

  onVideoReady: (v) => {

    // 定期的に呼ばれる各単語の "animate" 関数をセットする

    let w = player.video.firstWord;

    while (w) {

      w.animate = animateWord;

      w = w.next;

    }

  },

});

function updateCardText(suit, newText){
    document.getElementById(`${suit}-cardtext-style`).textContent = `.cardtext::after{ content: "${newText}" }`
}

function pauseAnimation(){
  document.getElementById("animation-state").textContent=".deck-position{animation-play-state: paused;} .card{animation-play-state: paused;}"
}

function playAnimation(){
  document.getElementById("animation-state").textContent=".deck-position{animation-play-state: running;} .card{animation-play-state: running;}"
}

function resetAnimation() {
  pauseAnimation();
  // To reset the animation, we remove the classes containing them, trigger reflow, then add them back in
  for (const element of document.getElementsByClassName("deck-position")) {
    element.classList.remove("deck-position");
    element.offsetWidth;
    element.classList.add("deck-position");
  };
  for (const element of document.getElementsByClassName("card")) {
    element.classList.remove("card");
    element.offsetWidth;
    element.classList.add("card");
  };
}

//temp, use player callback
var isPlaying = false;

// Setting up controls
document.querySelector("a#play").addEventListener("click", (e) => {
  e.preventDefault();
  if (isPlaying) {
    pauseAnimation();
    document.querySelector("a#play").textContent = "⏵";
    isPlaying = false;
  }
  else {
    playAnimation();
    document.querySelector("a#play").textContent = "⏸︎";
    isPlaying = true;
  }
});

document.querySelector("a#stop").addEventListener("click", (e) => {
  e.preventDefault();
  if (isPlaying) {
    document.querySelector("a#play").textContent = "⏵";
    isPlaying = false;
  }
  resetAnimation();
})
</script>

<style>
    @keyframes throw {
      25% {
        z-index: 1;
        offset-distance: 0%;
        offset-rotate: 0deg;
      }
      100% {
        z-index: 0;
        offset-distance: 100%;
        offset-rotate: 70deg;
      }
    }
    @keyframes bounce {
      50% {
        transform: translateY(20px) rotateX(18deg) rotateY(21deg) rotateZ(-29deg);
      }
    }
    body::before {
      content: "";
      position: absolute;
      width: 1200vw;
      height: 700vw;
      top: -250vw;
      left: -350vw;
      z-index: -1;
      background: url("images/background_tile.png") top left repeat;
      transform: skew(10deg, 20deg);
    }
    body {
      margin: 0px;
      overflow: hidden;
    }

    .deck-position {
        position: absolute;
        top: 300px;
        left: 25%;
        transform: rotateX(18deg) rotateY(21deg) rotateZ(-29deg);
        transform-style: preserve-3d;
        animation: bounce 0.5s ease-in-out infinite;
        animation-delay: 0.25s;
    }
    .card {
        display: block;
        position: absolute;
        width: 300px;
        height: 420px;
        border: 1px solid black;
        margin: 0px;
        background-color: rgb(230, 221, 221);
        transform: translateZ(50px);
        offset-path: path("M 150 210 C 559 58 1323 166 3165 914");
        /* The offset path can't start at (0, 0), that would put the centre of the card in
        the top-left corner of the deck. But starting it at (width/2, height/2) also rotates it,
        because offset-path defaults to rotating things to line up with the path. This is
        actually useful for the animation, so it shouldn't be disabled. The solution is to
        undo that initial rotation, which has a value of atan(height/width) */
        offset-rotate: 0deg;
        animation: throw 2s ease-in infinite;
    }
    .deck-front {
      display: block;
      position: absolute;
      width: 300px;
      height: 100px;
      top: 470px;
      border: 1px solid black;
      transform: rotateX(90deg) translateZ(100px);
      background-color: rgb(185, 178, 178);
    }
    .deck-right {
      display: block;
      position: absolute;
      width: 100px;
      height: 420px;
      left: -100px;
      border: 1px solid black;
      transform: rotateY(90deg) translateZ(50px);
      background-color: rgb(185, 178, 178);
    }
    .cardtext {
        font-size: 2em;
        white-space: nowrap;
    }
    .cardtext::before {
      font-size: 1.5em;
    }
    .cardtext-top {
        position: relative;
        left: 10px;
        top: 5px;
        height: 0px;
        width: 0px;
    }
    .cardtext-bottom {
        position: relative;
        top: calc(100% - 5px);
        left: calc(100% - 10px);
        transform: rotate(180deg);
        height: 0px;
        width: 0px;
    }
    .image-zone {
        position: relative;
        width: 210px;
        height: 294px;
        left: 45px;
        top: 63px;
        border: 1px solid black;
    }

    .heart-card {
      animation-delay: 0s;
    }
    .heart-card > .cardtext::before {
      content: "♥ ";
    }
    .heart-card > .cardtext {
      color: rgb(197, 32, 32);
    }

    .diamond-card {
      animation-delay: 1s;
    }
    .diamond-card > .cardtext::before {
      content: "♦ ";
    }
    .diamond-card > .cardtext {
      color: rgb(197, 32, 32);
    }

    .club-card {
      animation-delay: 1.5s;
    }
    .club-card > .cardtext::before {
      content: "♣ ";
    }
    .club-card > .cardtext {
      color: rgb(0, 0, 0);
    }

    .spade-card {
      animation-delay: 0.5s;
    }
    .spade-card > .cardtext::before {
      content: "♠ ";
    }
    .spade-card > .cardtext {
      color: rgb(0, 0, 0);
    }

    .header {
      position: absolute;
      top: 50px;
      font-family: monospace;
      background-color: rgb(0, 0, 0, .5);
      padding: 15px;
    }
    .header > a {
      padding: 15px;
      color: rgb(197, 32, 32);
      text-decoration: none;
    }
    .header > a:hover {
      color: rgb(233, 38, 38);
    }
    /*The stop icon is a little larger than play and pause,
    setting the text size to be smaller as a workaround*/
    #play {
      font-size: 3em;
    }
    #stop {
      font-size: 2.5em;
    }
</style>

<!--One-lining these, they'll be replaced with JS during the animation -->
<style id="heart-cardtext-style">.heart-card > .cardtext::after{ content: "テキスト" }</style>
<style id="diamond-cardtext-style">.diamond-card > .cardtext::after{ content: "テキスト" }</style>
<style id="club-cardtext-style">.club-card > .cardtext::after{ content: "テキスト" }</style>
<style id="spade-cardtext-style">.spade-card > .cardtext::after{ content: "テキスト" }</style>
<style id="animation-state">.deck-position{animation-play-state: paused;} .card{animation-play-state: paused;}</style>

</head>

<body>
  <div id="media"></div>
  <div class="header">
    <a href="#" id="play" class="disabled">⏵</a>
    <a href="#" id="stop" class="disabled">⏹</a>
  </div>
  <div class="deck-position">
    <div class="card club-card">
      <div class="cardtext cardtext-top"></div>
      <div class="cardtext cardtext-bottom"></div>
      <div class="image-zone club-image"></div>
    </div>
    <div class="card diamond-card">
      <div class="cardtext cardtext-top"></div>
      <div class="cardtext cardtext-bottom"></div>
      <div class="image-zone diamond-image"></div>
    </div>
    <div class="card spade-card">
      <div class="cardtext cardtext-top"></div>
      <div class="cardtext cardtext-bottom"></div>
      <div class="image-zone spade-image"></div>
    </div>
    <div class="card heart-card">
      <div class="cardtext cardtext-top"></div>
      <div class="cardtext cardtext-bottom"></div>
      <div class="image-zone heart-image"></div>
    </div>
    <div class="deck-front"></div>
    <div class="deck-right"></div>
  </div>
</body>
</html>